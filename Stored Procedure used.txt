USE [jose]
GO
/****** Object:  StoredProcedure [dbo].[InsterttoInvoice]    Script Date: 1/24/2023 5:39:38 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Mwita Joseph
-- Create date: Tuesday 24 2023 1227hrs
-- Description:	Create a sample procedure to insert to/update sample invoice table
-- =============================================
ALTER PROCEDURE [dbo].[InsterttoInvoice] -- 'inv-001', 320, 280, 'Alexandar Joseph'
	-- Add the parameters for the stored procedure here
		@Invoice_ID nvarchar(20)
        ,@Total_Billable money
        ,@Total_Taxable money
		,@Served_By nvarchar(250)
AS
BEGIN -- Start of procedure
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	BEGIN TRY -- Before any transaction we enclose it in a catch statement
		
		BEGIN TRANSACTION -- Start of our transaction

		IF (NOT (EXISTS(SELECT TOP 1 * FROM Invoice WHERE Invoice.Invoice_ID = @Invoice_ID)))
			BEGIN -- Start of an if statement
				INSERT INTO [Invoice]
					   ([Invoice_ID]
					   ,[Date_Served]
					   ,[Total_Billable]
					   ,[Total_Taxable]
					   ,[Served_By])
				 VALUES
					   (@Invoice_ID
					   ,GetDate()
					   ,@Total_Billable
					   ,@Total_Taxable
					   ,@Served_By)
			END -- End of an if statement
		ELSE -- Perform an update
			BEGIN
				INSERT INTO [InvoiceHistory] -- Create history before updating Original table
					   ([Invoice_ID]
					   ,[Date_Served]
					   ,[Total_Billable]
					   ,[Total_Taxable]
					   ,[Served_By])
				SELECT Invoice_ID, Date_Served, Total_Billable, Total_Taxable, Served_By FROM invoice WHERE Invoice.Invoice_ID = @Invoice_ID;
				UPDATE [dbo].[Invoice]
				   SET
					  [Total_Billable] = @Total_Billable
					  ,[Total_Taxable] = @Total_Taxable
					  ,[Served_By] = @Served_By
				 WHERE Invoice.Invoice_ID = @Invoice_ID;
				
			END -- end of else 


		COMMIT TRANSACTION -- End of our transaction
	END TRY

	BEGIN CATCH --Rollback transaction in case of error
		ROLLBACK TRANSACTION 
		declare @ErrorMessage nvarchar(500)        
		declare @ErrorSeverity nvarchar(50)        
		declare @ErrorState nvarchar(50)        
		SET @ErrorMessage  = ERROR_MESSAGE()        
		SET @ErrorSeverity = ERROR_SEVERITY()        
		SET @ErrorState    = ERROR_STATE()        
		RAISERROR(@ErrorMessage, @ErrorSeverity, @ErrorState)   
	END CATCH

    
END --End of procedure
